{"version":3,"sources":["../../src/lib/controllers.js"],"names":["privileges","require","main","categories","p","promisify","getAllCategoryFields","filterCids","shadeColor2","color","percent","f","parseInt","slice","t","R","G","B","Math","round","toString","router","middleware","renderAdmin","req","res","next","then","settings","render","catch","get","admin","buildHeader","resolve","JSON","parse","query","sendStatus","post","body","renderPage","cb","err","data","uid","cats","filtered","map","c","cid","colors","filter","includes","style","bgColor","params","pid","eventPid","day","eventDay","calendarEventsStyle","join","title","raw","event","repeats","startDate","endDate","occurenceDate","Date","s","setUTCFullYear","getUTCFullYear","setUTCDate","getUTCDate","setUTCMonth","getUTCMonth","valueOf","responses","eventData","eventJSON","stringify","eventHTML","asCallback"],"mappings":"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","file":"controllers.js","sourcesContent":["import Promise from 'bluebird';\nimport { getEvent, escapeEvent } from './event';\nimport { canViewPost } from './privileges';\nimport { eventTemplate } from './templates';\nimport { getUserResponse } from './responses';\nimport { getSettings, setSettings } from './settings';\nimport { addICal } from './icals';\n\nconst privileges = require.main.require('./src/privileges');\nconst categories = require.main.require('./src/categories');\n\nconst p = Promise.promisify;\n\nconst getAllCategoryFields = p(categories.getAllCategoryFields);\nconst filterCids = p(privileges.categories.filterCids);\n\n/* eslint-disable */\nfunction shadeColor2(color, percent) {\n  var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;\n  return \"#\"+(0x1000000+(Math.round((t-R)*p)+R)*0x10000+(Math.round((t-G)*p)+G)*0x100+(Math.round((t-B)*p)+B)).toString(16).slice(1);\n}\n/* eslint-enable */\n\nexport default (router, middleware) => {\n  const renderAdmin = (req, res, next) => {\n    getSettings().then((settings) => {\n      res.render('admin/plugins/calendar', {\n        settings,\n      });\n    }).catch(next);\n  };\n  router.get('/admin/plugins/calendar', middleware.admin.buildHeader, renderAdmin);\n  router.get('/api/admin/plugins/calendar', renderAdmin);\n\n  router.get('/api/admin/plugins/calendar/save', (req, res, next) => {\n    Promise.resolve()\n      .then(() => setSettings(JSON.parse(req.query.settings)))\n      .then(() => res.sendStatus(200))\n      .catch(next);\n  });\n\n  router.post('/api/admin/plugins/calendar/add', (req, res, next) => {\n    Promise.resolve()\n      .then(() => addICal(req.body))\n      .then(() => res.sendStatus(201))\n      .catch(next);\n  });\n\n  const renderPage = (req, res, next) => {\n    const cb = (err, data) => {\n      if (err) {\n        next(err);\n        return;\n      }\n      res.render('calendar', data);\n    };\n\n    // not using server rendering for events because it could be a lot of info\n    // better to have a fast page load time\n\n    (async () => {\n      const uid = req.uid;\n      const cats = await getAllCategoryFields(['cid', 'bgColor']);\n      const filtered = await filterCids('read', cats.map(c => c.cid), uid);\n\n      const colors = cats.filter(c => filtered.includes(c.cid));\n\n      const style = colors.map(({ cid, bgColor }) => `\n        .plugin-calendar-cal-event-category-${cid} {\n        background-color: ${bgColor};\n        border-color: ${shadeColor2(bgColor, -0.2)};\n      }`);\n\n      const { eventPid: pid, eventDay: day } = req.params;\n\n      if (!pid || !(await canViewPost(pid, uid))) {\n        return {\n          calendarEventsStyle: style.join('\\n'),\n          title: '[[calendar:calendar]]',\n        };\n      }\n\n      const raw = await getEvent(pid);\n      const event = await escapeEvent(raw);\n      event.day = day || null;\n\n      if (event.repeats && event.day) {\n        const { startDate, endDate } = event;\n        const occurenceDate = new Date(day);\n        const s = new Date(startDate);\n\n        s.setUTCFullYear(occurenceDate.getUTCFullYear());\n        s.setUTCDate(occurenceDate.getUTCDate());\n        s.setUTCMonth(occurenceDate.getUTCMonth());\n\n        event.startDate = s.valueOf();\n        event.endDate = event.startDate + (endDate - startDate);\n      }\n\n      event.responses = {\n        [uid]: await getUserResponse({ pid, day, uid }),\n      };\n\n      return {\n        calendarEventsStyle: style.join('\\n'),\n        title: '[[calendar:calendar]]',\n        eventData: event,\n        eventJSON: JSON.stringify(event),\n        eventHTML: eventTemplate({ event, uid }),\n      };\n    })().asCallback(cb);\n  };\n\n  router.get('/calendar/event/:eventPid/:eventDay', middleware.buildHeader, renderPage);\n  router.get('/api/calendar/event/:eventPid/:eventDay', renderPage);\n  router.get('/calendar/event/:eventPid', middleware.buildHeader, renderPage);\n  router.get('/api/calendar/event/:eventPid', renderPage);\n  router.get('/calendar', middleware.buildHeader, renderPage);\n  router.get('/api/calendar', renderPage);\n};\n"]}