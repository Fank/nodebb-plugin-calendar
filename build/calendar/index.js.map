{"version":3,"sources":["../../src/calendar/index.js"],"names":["queryRegExp","begin","momentLang","calendarOptions","editable","header","left","center","right","lang","events","start","end","timezone","callback","socket","emit","startDate","valueOf","endDate","err","message","app","alertError","eventClick","e","original","pid","id","preventDefault","stopPropagation","external","repeats","ajaxify","updateHistory","day","shouldHandle","listen","state","data","prev","startsWith","current","url","init","$calendar","$","fullCalendar","btn","on","toggleClass","detach","appendTo","find","$display","modal","matches","location","pathname","match","parseInt","el","getEventCache","x","event","history","replaceState","RELATIVE_PATH","window","calendarEventData","document","ready","__webpack_public_path__","config","userLang","defaultLang","toLowerCase","replace","require","split","er","Error"],"mappings":"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","file":"index.js","sourcesContent":["import 'fullcalendar';\nimport convertToFC from './convertToFC';\nimport displayEvent from './displayEvent';\nimport locationHistory from '../client/locationHistory';\nimport { setupDTP } from '../client/responses';\n\nconst queryRegExp = /calendar\\/?(?:\\/*event\\/+([0-9]+))?/;\n\nconst begin = (momentLang) => {\n  const calendarOptions = {\n    editable: false,\n    header: {\n      left: 'prev,next today',\n      center: 'title',\n      right: 'month,agendaWeek,agendaDay',\n    },\n    lang: momentLang,\n    events: (start, end, timezone, callback) => {\n      socket.emit('plugins.calendar.getEventsByDate', {\n        startDate: start.valueOf(),\n        endDate: end.valueOf(),\n      }, (err, events) => {\n        if (err) {\n          if (err.message) {\n            app.alertError(err);\n          }\n          throw err;\n        }\n\n        callback(convertToFC(events));\n      });\n    },\n    eventClick: ({ original, id: pid }, e) => {\n      e.preventDefault();\n      e.stopPropagation();\n      displayEvent(original);\n      if (original.external) {\n        // TODO\n      } else {\n        if (original.repeats) {\n          ajaxify.updateHistory(`calendar/event/${pid}/${original.day}`);\n        } else {\n          ajaxify.updateHistory(`calendar/event/${pid}`);\n        }\n      }\n    },\n    timezone: 'local',\n  };\n\n  let shouldHandle = false;\n\n  locationHistory.listen((state, data) => {\n    if (state.prev.startsWith('calendar') && state.current.startsWith('calendar')) {\n      data.url = null; // eslint-disable-line no-param-reassign\n      shouldHandle = true;\n    } else {\n      shouldHandle = false;\n    }\n  });\n\n  const init = () => {\n    const $calendar = $('#calendar');\n\n    if ($calendar && !shouldHandle) {\n      $calendar.fullCalendar(calendarOptions);\n      const btn = $('#plugin-calendar-cal-only-yes');\n      btn\n        .on('click', (e) => {\n          e.preventDefault();\n          $calendar.toggleClass('plugin-calendar-cal-only-yes');\n          btn.toggleClass('active');\n        })\n        .detach()\n        .appendTo($calendar.find('.fc-toolbar .fc-right'));\n    }\n\n    const $display = $('#plugin-calendar-cal-event-display');\n    if ($display) {\n      $display.on('click', '.dismiss', () => {\n        $display.modal('hide');\n        ajaxify.updateHistory('calendar');\n      });\n    }\n\n    const matches = location.pathname.match(queryRegExp);\n    const pid = matches && parseInt(matches[1], 10);\n    if (pid) {\n      const el = $calendar\n        .data('fullCalendar')\n        .getEventCache()\n        .find(x => x.id === pid);\n\n      if (shouldHandle) {\n        const event = el && el.original;\n        if (event) {\n          displayEvent(event);\n        } else {\n          history.replaceState({}, '', `${RELATIVE_PATH}/calendar`);\n        }\n      } else {\n        setupDTP($display.find('[data-day]'), window.calendarEventData.day);\n      }\n      $calendar.fullCalendar('gotoDate', el ? el.start : (\n        window.calendarEventData.day || window.calendarEventData.startDate\n      ));\n    } else if (shouldHandle) {\n      $display.modal('hide');\n    }\n  };\n\n  $(document).ready(init);\n  $(window).on('action:ajaxify.end', init);\n};\n\n__webpack_public_path__ = `${RELATIVE_PATH}/plugins/nodebb-plugin-calendar/bundles/`; // eslint-disable-line\n\nconst lang = config.userLang || config.defaultLang;\nconst momentLang = lang.toLowerCase().replace(/_/g, '-');\n\ntry {\n  if (momentLang === 'en-us') {\n    begin('en-us');\n  } else {\n    require(`bundle-loader!fullcalendar/dist/locale/${momentLang}`)(() => { // eslint-disable-line\n      begin(momentLang);\n    });\n  }\n} catch (e) {\n  try {\n    require(`bundle-loader!fullcalendar/dist/locale/${momentLang.split('-')[0]}`)(() => { // eslint-disable-line\n      begin(momentLang);\n    });\n  } catch (er) {\n    begin('en-us');\n    throw Error(`Could not load locale data (${momentLang}) for fullcalendar`);\n  }\n}\n"]}