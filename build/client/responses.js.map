{"version":3,"sources":["../../src/client/responses.js"],"names":["userTemplate","user","config","relative_path","userslug","picture","username","noYesResponses","noMaybeResponses","noNoResponses","addResponsesToPost","pid","cb","$responses","$","day","attr","length","socket","emit","err","responses","message","app","alertError","yes","maybe","no","yess","find","maybes","nos","map","empty","append","setupDTP","dayInput","m","Date","now","datetimepicker","icons","time","date","up","down","previous","next","today","clear","close","allowInputToggle","locale","userLang","defaultLang","toLowerCase","replace","format","useCurrent","data","noop","setupPost","e","buttonCont","closest","uid","remove","value","button","siblings","removeClass","addClass","initResponses","document","body","on","target","alertSuccess","input","toISOString","split","checkPosts","posts","post","ajaxify","setTimeout","forEach","notLoaded","is","parseInt","toggle","panel","cont","height","children","scrollHeight","css","toggleClass","window","join","requirejs","translator","translate","translated","text"],"mappings":"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","file":"responses.js","sourcesContent":["import moment from 'moment';\n\nconst userTemplate = user => (`\n  <li class=\"icon pull-left\">\n    <a href=\"${config.relative_path}/user/${user.userslug}\">\n      ${user.picture ? `\n      <img title=\"${user.username}\" class=\"img-rounded user-img not-responsive\"\n        src=\"${user.picture}\">\n      ` : `\n      <div class=\"user-icon user-img\" style=\"background-color: ${user['icon:bgColor']};\"\n        title=\"${user.username}\">${user['icon:text']}</div>\n      `}\n    </a>\n  </li>\n`);\n\nlet noYesResponses;\nlet noMaybeResponses;\nlet noNoResponses;\n\nconst addResponsesToPost = (pid, cb) => {\n  const $responses = $(`[data-pid=${pid}] .plugin-calendar-event-responses-lists`);\n  const day = $(`[data-pid=${pid}] [data-day]`).attr('data-day');\n\n  if (!$responses.length) {\n    return;\n  }\n\n  socket.emit('plugins.calendar.getResponses', { pid, day }, (err, responses) => {\n    if (err) {\n      if (err.message) {\n        app.alertError(err);\n      }\n      throw err;\n    }\n    if (!responses ||\n    !responses.yes ||\n    !responses.maybe ||\n    !responses.no) {\n      return;\n    }\n\n    const yess = $responses.find('.plugin-calendar-event-responses-list-yes');\n    const maybes = $responses.find('.plugin-calendar-event-responses-list-maybe');\n    const nos = $responses.find('.plugin-calendar-event-responses-list-no');\n\n    const yes = responses.yes.map(userTemplate);\n    const maybe = responses.maybe.map(userTemplate);\n    const no = responses.no.map(userTemplate);\n\n    yess.empty().append(yes.length ? yes : noYesResponses);\n    maybes.empty().append(maybe.length ? maybe : noMaybeResponses);\n    nos.empty().append(no.length ? no : noNoResponses);\n\n    cb();\n  });\n};\n\nconst setupDTP = (responses, day) => {\n  const dayInput = responses.find('.plugin-calendar-event-responses-day input');\n  if (!dayInput.length) {\n    return;\n  }\n  const m = moment(day || Date.now());\n\n  dayInput.datetimepicker({\n    icons: {\n      time: 'fa fa-clock-o',\n      date: 'fa fa-calendar',\n      up: 'fa fa-arrow-up',\n      down: 'fa fa-arrow-down',\n      previous: 'fa fa-arrow-left',\n      next: 'fa fa-arrow-right',\n      today: 'fa fa-crosshairs',\n      clear: 'fa fa-trash',\n      close: 'fa fa-times',\n    },\n    allowInputToggle: true,\n    locale: (config.userLang || config.defaultLang).toLowerCase().replace(/_/g, '-'),\n    format: 'L',\n    useCurrent: true,\n  })\n  .data('DateTimePicker')\n  .date(m);\n};\n\nconst noop = () => {};\n\nconst setupPost = ({ pid, e }, cb = noop) => {\n  let buttonCont = $(`[data-pid=${pid}] .plugin-calendar-event-responses-user`);\n  const responses = buttonCont.closest('[data-day]');\n  const day = responses.attr('data-day') || null;\n\n  if (!buttonCont.length) {\n    cb();\n    return;\n  }\n\n  if (!app.user.uid) {\n    buttonCont.remove();\n    cb();\n    return;\n  }\n\n  if (!e) {\n    setupDTP(responses, day);\n  }\n\n  socket.emit('plugins.calendar.getUserResponse', { pid, day }, (err, value) => {\n    if (err) {\n      app.alertError(err);\n      throw err;\n    }\n\n    buttonCont = $(`[data-pid=${pid}] .plugin-calendar-event-responses-user`);\n    const button = buttonCont.find(`[data-value=${value || 'no'}]`);\n\n    button.siblings().removeClass('active');\n    button.addClass('active');\n\n    cb();\n  });\n};\n\nconst initResponses = () => {\n  $(document.body).on('click', '.plugin-calendar-event-responses-user .btn', (e) => {\n    const button = $(e.target);\n    const value = button.data('value');\n    const pid = button.closest('[data-pid]').attr('data-pid');\n    const day = button.closest('[data-day]').attr('data-day');\n\n    socket.emit('plugins.calendar.submitResponse', { pid, value, day }, (err) => {\n      if (err) {\n        if (err.message) {\n          app.alertError(err);\n        }\n        throw err;\n      }\n      app.alertSuccess();\n      button.siblings().removeClass('active');\n      button.addClass('active');\n    });\n  });\n\n  $(document.body).on('change dp.change', '.plugin-calendar-event-responses-day input', (e) => {\n    const input = $(e.target);\n    const day = input\n      .data('DateTimePicker').date()\n      .toISOString()\n      .split('T')[0];\n    const pid = input.closest('[data-pid]').attr('data-pid');\n    const responses = input.closest('[data-day]');\n    responses.attr('data-day', day);\n\n    responses\n      .find('.plugin-calendar-event-responses-lists')\n      .attr('data-loaded', 'false')\n      .find('.panel')\n      .addClass('closed');\n\n    setupPost({ pid, e });\n  });\n\n  const checkPosts = (e, data) => {\n    const posts = data.posts || data.post || ajaxify.data.posts;\n\n    if (posts && posts.length > 0) {\n      setTimeout(() => {\n        posts.forEach(post => setupPost({ pid: post.pid }));\n      }, 200);\n    }\n  };\n\n  $(document.body).on(\n    'click',\n    '[data-pid] .plugin-calendar-event-responses-lists .panel-heading a',\n    (e) => {\n      const target = $(e.target).closest('a');\n      const notLoaded = target.is('[data-loaded=false] a');\n      const pid = parseInt(target.closest('[data-pid]').attr('data-pid'), 10);\n\n      const toggle = () => {\n        const panel = target.closest('.panel');\n        const cont = panel.find('.panel-collapse');\n        const height = cont.children()[0].scrollHeight;\n        cont.css('height', `${height}px`);\n        panel.toggleClass('closed');\n      };\n\n      if (notLoaded) {\n        addResponsesToPost(pid, toggle);\n        target\n          .closest('.plugin-calendar-event-responses-lists')\n          .attr('data-loaded', 'true');\n      } else {\n        toggle();\n      }\n    }\n  );\n\n  $(window).on([\n    'action:posts.loaded',\n    'action:ajaxify.end',\n    'action:posts.edited',\n  ].join(' '), checkPosts);\n  checkPosts(null, ajaxify.data);\n\n  window.requirejs(['translator'], (translator) => {\n    translator.translate(\n      '[[calendar:no_x_responses, [[calendar:response_yes]]]],' +\n      '[[calendar:no_x_responses, [[calendar:response_maybe]]]],' +\n      '[[calendar:no_x_responses, [[calendar:response_no]]]]',\n      (translated) => {\n        const text = translated.split(',');\n        noYesResponses = text[0];\n        noMaybeResponses = text[1];\n        noNoResponses = text[2];\n      }\n    );\n  });\n};\n\nexport default initResponses;\nexport { setupPost, setupDTP };\n"]}